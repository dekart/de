#!/usr/bin/env ruby

system %{mkdir -p tmp}

if ARGV.include?('clean')
  puts "Cleaning caches..."

  system %{rm -rf public/assets/* tmp/cache/*}
end

flags = []

if ARGV.include?('offline')
  puts 'Running offline...'

  flags << "OFFLINE=true"
end

existing = `pgrep -f 'nginx.*master'`.strip

if existing.size > 0
  puts "Stopping currently running server..."

  system %{sudo kill #{existing}}
end

certificate_path      = File.expand_path("./config/deploy/certificates/development.csr")
certificate_key_path  = File.expand_path("./config/deploy/certificates/development.key")

if File.file?(certificate_path) and File.file?(certificate_key_path)
  puts "Starting server with HTTPS..."

  system %{#{flags.join(' ')} passenger start --max-pool-size=3 --ssl --ssl-port=3001 --ssl-certificate=#{certificate_path} --ssl-certificate-key=#{certificate_key_path}}
else
  puts "Starting server..."

  system %{#{flags.join(' ')} passenger start --max-pool-size=3}
end

